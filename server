// server.js â€” KringloopKompas REST API
require(â€˜dotenvâ€™).config();
const express = require(â€˜expressâ€™);
const cors = require(â€˜corsâ€™);
const cron = require(â€˜node-cronâ€™);
const db = require(â€™./dbâ€™);
const { runScraper } = require(â€™./scraperâ€™);

const app = express();
const PORT = process.env.PORT || 3001;

// â”€â”€â”€ Middleware â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

app.use(cors({
origin: process.env.ALLOWED_ORIGINS?.split(â€™,â€™) || â€˜*â€™,
}));
app.use(express.json());

// Simpele API-key bescherming voor write-endpoints (optioneel)
function requireKey(req, res, next) {
const key = process.env.API_KEY;
if (!key) return next(); // geen key ingesteld = open
if (req.headers[â€˜x-api-keyâ€™] === key) return next();
res.status(401).json({ error: â€˜Ongeldige API keyâ€™ });
}

// â”€â”€â”€ Routes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// GET /shops â€” alle winkels (met optionele filters)
app.get(â€™/shopsâ€™, (req, res) => {
try {
let shops = db.getAll();

```
// Filter: assortiment
if (req.query.assortment) {
  const cats = req.query.assortment.split(',');
  shops = shops.filter(s => cats.some(c => s.assortment.includes(c)));
}

// Filter: min rating
if (req.query.minRating) {
  shops = shops.filter(s => s.rating >= parseFloat(req.query.minRating));
}

// Filter: stad
if (req.query.city) {
  const city = req.query.city.toLowerCase();
  shops = shops.filter(s => s.city.toLowerCase().includes(city));
}

// Filter: open nu
if (req.query.openNow === 'true') {
  shops = shops.filter(s => isOpenNow(s.hours));
}

// Sorteer op afstand als postcode meegegeven
if (req.query.lat && req.query.lng) {
  const userLat = parseFloat(req.query.lat);
  const userLng = parseFloat(req.query.lng);
  shops.sort((a, b) =>
    haversine(userLat, userLng, a.lat, a.lng) - haversine(userLat, userLng, b.lat, b.lng)
  );
  // Voeg afstand toe
  shops = shops.map(s => ({
    ...s,
    distanceKm: Math.round(haversine(userLat, userLng, s.lat, s.lng) * 10) / 10
  }));
}

res.json({ count: shops.length, shops });
```

} catch (e) {
res.status(500).json({ error: e.message });
}
});

// GET /shops/:id â€” Ã©Ã©n winkel
app.get(â€™/shops/:idâ€™, (req, res) => {
const shop = db.getById(req.params.id);
if (!shop) return res.status(404).json({ error: â€˜Winkel niet gevondenâ€™ });
res.json(shop);
});

// POST /shops â€” nieuwe winkel toevoegen
app.post(â€™/shopsâ€™, requireKey, (req, res) => {
const { name, city } = req.body;
if (!name || !city) return res.status(400).json({ error: â€˜name en city zijn verplichtâ€™ });

const shop = {
â€¦req.body,
id: req.body.id || generateId(name, city),
source: â€˜handmatigâ€™,
};

try {
db.upsert(shop);
res.status(201).json(db.getById(shop.id));
} catch (e) {
res.status(500).json({ error: e.message });
}
});

// PUT /shops/:id â€” winkel bijwerken
app.put(â€™/shops/:idâ€™, requireKey, (req, res) => {
const existing = db.getById(req.params.id);
if (!existing) return res.status(404).json({ error: â€˜Winkel niet gevondenâ€™ });

try {
db.upsert({ â€¦existing, â€¦req.body, id: req.params.id });
res.json(db.getById(req.params.id));
} catch (e) {
res.status(500).json({ error: e.message });
}
});

// DELETE /shops/:id â€” winkel verwijderen
app.delete(â€™/shops/:idâ€™, requireKey, (req, res) => {
db.remove(req.params.id);
res.json({ ok: true });
});

// POST /scrape â€” scraper handmatig starten
app.post(â€™/scrapeâ€™, requireKey, async (req, res) => {
const sources = req.body.sources || [â€˜osmâ€™];
res.json({ ok: true, message: â€˜Scraper gestart op de achtergrondâ€™ });
// Async, blocking response al gestuurd
try {
await runScraper({ sources });
} catch (e) {
console.error(â€˜Scraper fout:â€™, e);
}
});

// GET /stats â€” database statistieken
app.get(â€™/statsâ€™, (req, res) => {
res.json(db.getStats());
});

// Health check
app.get(â€™/healthâ€™, (req, res) => res.json({ ok: true, time: new Date().toISOString() }));

// â”€â”€â”€ Geplande scraper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Elke nacht om 03:00 draaien
cron.schedule(â€˜0 3 * * *â€™, async () => {
console.log(â€˜â° Nachtelijke scraper gestartâ€¦â€™);
try {
await runScraper({ sources: [â€˜osmâ€™, â€˜kringloopwijzerâ€™] });
} catch (e) {
console.error(â€˜Geplande scraper fout:â€™, e);
}
}, { timezone: â€˜Europe/Amsterdamâ€™ });

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function haversine(lat1, lng1, lat2, lng2) {
const R = 6371;
const dLat = (lat2 - lat1) * Math.PI / 180;
const dLng = (lng2 - lng1) * Math.PI / 180;
const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function isOpenNow(hours) {
const days = [â€˜Zoâ€™,â€˜Maâ€™,â€˜Diâ€™,â€˜Woâ€™,â€˜Doâ€™,â€˜Vrâ€™,â€˜Zaâ€™];
const today = days[new Date().getDay()];
const h = hours?.[today];
if (!h || h === â€˜Geslotenâ€™) return false;
const [open, close] = h.split(â€™ - â€˜);
const now = new Date();
const nowMins = now.getHours() * 60 + now.getMinutes();
const [oh, om] = open.split(â€™:â€™).map(Number);
const [ch, cm] = close.split(â€™:â€™).map(Number);
return nowMins >= oh * 60 + om && nowMins < ch * 60 + cm;
}

function generateId(name, city) {
return `${name}-${city}`.toLowerCase().replace(/[^a-z0-9]+/g, â€˜-â€™).replace(/^-|-$/g, â€˜â€™);
}

// â”€â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

app.listen(PORT, () => {
console.log(`\nðŸ§º KringloopKompas API draait op poort ${PORT}`);
console.log(`   GET  /shops`);
console.log(`   GET  /shops/:id`);
console.log(`   POST /shops`);
console.log(`   POST /scrape`);
console.log(`   GET  /stats`);
console.log(`   GET  /health\n`);
});
