// scraper.js â€” Haalt kringloop- en vintagewinkels op uit meerdere bronnen
require(â€˜dotenvâ€™).config();
const { chromium } = require(â€˜playwrightâ€™);
const axios = require(â€˜axiosâ€™);
const cheerio = require(â€˜cheerioâ€™);
const { upsert, logScrape } = require(â€™./dbâ€™);

// â”€â”€â”€ Hulpfuncties â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function generateId(name, city) {
return `${name}-${city}`.toLowerCase()
.replace(/[^a-z0-9]+/g, â€˜-â€™)
.replace(/^-|-$/g, â€˜â€™);
}

function normalizePostcode(raw) {
if (!raw) return null;
const match = raw.replace(/\s/g, â€˜â€™).match(/(\d{4}[A-Z]{2})/i);
return match ? match[1].toUpperCase() : null;
}

// Ruwe postcode â†’ lat/lng (simpele lookup voor NL regioâ€™s)
// In productie: gebruik een geocoding API zoals Nominatim/OpenStreetMap
const POSTCODE_CENTROIDS = {
â€˜10â€™: [52.37, 4.90], â€˜11â€™: [52.36, 4.91], â€˜12â€™: [52.38, 4.89],
â€˜20â€™: [52.38, 4.64], â€˜21â€™: [52.35, 4.57], â€˜22â€™: [52.39, 4.63],
â€˜25â€™: [52.07, 4.30], â€˜26â€™: [52.05, 4.36], â€˜27â€™: [52.01, 4.37],
â€˜30â€™: [51.92, 4.48], â€˜31â€™: [51.91, 4.47], â€˜32â€™: [51.93, 4.50],
â€˜35â€™: [52.09, 5.12], â€˜36â€™: [52.08, 5.10], â€˜37â€™: [52.07, 5.13],
â€˜40â€™: [51.57, 5.07], â€˜41â€™: [51.56, 5.09], â€˜56â€™: [51.44, 5.48],
â€˜63â€™: [51.83, 5.86], â€˜68â€™: [51.99, 5.91], â€˜75â€™: [52.27, 6.79],
â€˜80â€™: [53.20, 6.56], â€˜97â€™: [53.21, 6.57], â€˜98â€™: [53.22, 6.58],
â€˜85â€™: [51.69, 5.30], â€˜60â€™: [51.98, 5.91], â€˜76â€™: [52.51, 6.09],
};

function postcodeToCoords(pc) {
if (!pc) return [52.13, 5.29]; // centrum NL
const prefix = pc.substring(0, 2);
return POSTCODE_CENTROIDS[prefix] || [52.13, 5.29];
}

// Classify assortiment op basis van tekst
function classifyAssortment(text = â€˜â€™) {
const t = text.toLowerCase();
const tags = [];
if (t.match(/kleding|mode|fashion|shirts|broek|jas|jurk|blous/)) tags.push(â€˜Kledingâ€™);
if (t.match(/vintage|retro|jaren [456789]0|tweedehands.*design/)) tags.push(â€˜Vintageâ€™);
if (t.match(/stof|stoffen|textiel|laken|gordijn|naaien|mercerie/)) tags.push(â€˜Stoffenâ€™);
if (t.match(/naai|patroon|knoop|rits|mercerie|garen/)) tags.push(â€˜Naaibenodigdhedenâ€™);
if (t.match(/meubel|kast|tafel|stoel|bank|wonen|interieur/)) tags.push(â€˜Meubelsâ€™);
if (t.match(/boek|tijdschrift|cd|dvd|vinyl|plaat/)) tags.push(â€˜Boeken & mediaâ€™);
if (t.match(/electroni|computer|telefoon|apparaat/)) tags.push(â€˜Elektronicaâ€™);
if (t.match(/sieraad|ketting|ring|armband|juwel/)) tags.push(â€˜Sieradenâ€™);
if (t.match(/accessoire|tas|riem|sjaal|hoed/)) tags.push(â€˜Accessoiresâ€™);
return [â€¦new Set(tags)];
}

// â”€â”€â”€ Bron 1: OpenStreetMap Overpass API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Gratis, geen API-key nodig. Haalt alle second_hand winkels op in NL.

async function scrapeOpenStreetMap() {
console.log(â€˜ðŸ—º  Scraping OpenStreetMap (Overpass API)â€¦â€™);
const query = `[out:json][timeout:60]; area["ISO3166-1"="NL"]->.nl; ( node["shop"="second_hand"](area.nl); node["shop"="vintage"](area.nl); node["shop"="clothes"]["second_hand"="yes"](area.nl); node["amenity"="kringloopwinkel"](area.nl); ); out body;`;

const res = await axios.post(
â€˜https://overpass-api.de/api/interpreterâ€™,
`data=${encodeURIComponent(query)}`,
{ headers: { â€˜Content-Typeâ€™: â€˜application/x-www-form-urlencodedâ€™ }, timeout: 70000 }
);

const elements = res.data?.elements || [];
console.log(`   â†’ ${elements.length} locaties gevonden in OSM`);

const shops = [];
for (const el of elements) {
const tags = el.tags || {};
const name = tags.name || tags[â€˜name:nlâ€™];
if (!name) continue;

```
const city = tags['addr:city'] || tags['addr:place'] || 'Onbekend';
const postcode = normalizePostcode(tags['addr:postcode']);
const [lat, lng] = postcode
  ? postcodeToCoords(postcode)
  : [el.lat || 52.13, el.lon || 5.29];

// Bouw assortiment op basis van OSM tags + naam
const textForClassify = [name, tags.description, tags['shop:clothes'], tags.goods].filter(Boolean).join(' ');
const assortment = classifyAssortment(textForClassify);
if (assortment.length === 0) assortment.push('Kleding'); // standaard

const hours = parseOSMHours(tags.opening_hours);

shops.push({
  id: generateId(name, city),
  name,
  city,
  address: [tags['addr:street'], tags['addr:housenumber']].filter(Boolean).join(' ') || null,
  postcode,
  lat,
  lng,
  rating: 0,
  review_count: 0,
  phone: tags.phone || tags['contact:phone'] || null,
  website: tags.website || tags['contact:website'] || null,
  source: 'openstreetmap',
  hours,
  assortment,
  reviews: [],
});
```

}

return shops;
}

function parseOSMHours(raw) {
// Simpele parser voor â€œMo-Fr 09:00-17:00; Sa 09:00-15:00â€
const days = { Ma: null, Di: null, Wo: null, Do: null, Vr: null, Za: null, Zo: null };
if (!raw) return days;
// Zet standaard tijden als we de string herkennen
if (raw.includes(â€˜Mo-Frâ€™)) {
const match = raw.match(/Mo-Fr\s+([\d:]+)-([\d:]+)/);
if (match) {
[â€˜Maâ€™,â€˜Diâ€™,â€˜Woâ€™,â€˜Doâ€™,â€˜Vrâ€™].forEach(d => days[d] = `${match[1]} - ${match[2]}`);
}
}
if (raw.includes(â€˜Saâ€™)) {
const match = raw.match(/Sa\s+([\d:]+)-([\d:]+)/);
if (match) days[â€˜Zaâ€™] = `${match[1]} - ${match[2]}`;
}
if (raw.includes(â€˜Suâ€™) || raw.includes(â€˜PH offâ€™)) {
days[â€˜Zoâ€™] = â€˜Geslotenâ€™;
}
return days;
}

// â”€â”€â”€ Bron 2: Kringloopwijzer.nl scraper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function scrapeKringloopwijzer() {
console.log(â€˜ðŸŒ Scraping Kringloopwijzer.nlâ€¦â€™);
const browser = await chromium.launch({ headless: true });
const shops = [];

try {
const page = await browser.newPage();
await page.setExtraHTTPHeaders({ â€˜Accept-Languageâ€™: â€˜nl-NLâ€™ });

```
// Kringloopwijzer heeft een overzichtspagina per provincie
const provinces = ['noord-holland','zuid-holland','utrecht','gelderland',
                   'noord-brabant','limburg','overijssel','groningen','friesland',
                   'drenthe','flevoland','zeeland'];

for (const prov of provinces) {
  try {
    await page.goto(`https://www.kringloopwijzer.nl/winkels/${prov}`, {
      waitUntil: 'domcontentloaded', timeout: 15000
    });

    const items = await page.$$eval('.winkel-item, .shop-card, article.shop', els =>
      els.map(el => ({
        name: el.querySelector('h2, h3, .name')?.textContent?.trim(),
        city: el.querySelector('.city, .stad, .location')?.textContent?.trim(),
        address: el.querySelector('.address, .adres')?.textContent?.trim(),
        phone: el.querySelector('.phone, .tel')?.textContent?.trim(),
        website: el.querySelector('a[href*="http"]')?.href,
        description: el.querySelector('p, .description')?.textContent?.trim(),
      }))
    );

    for (const item of items) {
      if (!item.name) continue;
      const city = item.city || prov;
      const assortment = classifyAssortment(item.description || item.name);
      if (assortment.length === 0) assortment.push('Kleding');

      shops.push({
        id: generateId(item.name, city),
        name: item.name,
        city,
        address: item.address || null,
        postcode: null,
        lat: 52.13, lng: 5.29, // wordt verfijnd door geocoder
        rating: 0,
        review_count: 0,
        phone: item.phone || null,
        website: item.website || null,
        source: 'kringloopwijzer',
        hours: { Ma: null, Di: null, Wo: null, Do: null, Vr: null, Za: null, Zo: null },
        assortment,
        reviews: [],
      });
    }
    console.log(`   ${prov}: ${items.length} winkels`);
    await page.waitForTimeout(1000); // beleefd scrapen
  } catch (e) {
    console.warn(`   âš  ${prov}: ${e.message}`);
  }
}
```

} finally {
await browser.close();
}

console.log(`   â†’ ${shops.length} winkels van Kringloopwijzer`);
return shops;
}

// â”€â”€â”€ Bron 3: Marktplaats vintage kleding winkels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function scrapeMarktplaatsVintage() {
console.log(â€˜ðŸ›  Scraping Marktplaats vintage winkelsâ€¦â€™);
const browser = await chromium.launch({ headless: true });
const shops = [];

try {
const page = await browser.newPage();
await page.goto(â€˜https://www.marktplaats.nl/l/kleding-dames/p/1/?query=vintage+winkel&isShops=trueâ€™, {
waitUntil: â€˜domcontentloadedâ€™, timeout: 20000
});

```
const items = await page.$$eval('[data-item-id], .mp-Listing', els =>
  els.slice(0, 30).map(el => ({
    name: el.querySelector('.mp-Listing-title, h3')?.textContent?.trim(),
    city: el.querySelector('.mp-Listing-location, .location')?.textContent?.trim(),
    description: el.querySelector('.mp-Listing-description, p')?.textContent?.trim(),
  }))
);

for (const item of items) {
  if (!item.name || item.name.length < 3) continue;
  const city = item.city?.split(',')[0]?.trim() || 'Nederland';
  shops.push({
    id: generateId(item.name, city),
    name: item.name,
    city,
    address: null,
    postcode: null,
    lat: 52.13, lng: 5.29,
    rating: 0,
    review_count: 0,
    phone: null,
    website: null,
    source: 'marktplaats',
    hours: {},
    assortment: classifyAssortment(item.description || '') || ['Vintage', 'Kleding'],
    reviews: [],
  });
}
```

} catch (e) {
console.warn(â€™   âš  Marktplaats scrape mislukt:â€™, e.message);
} finally {
await browser.close();
}

console.log(`   â†’ ${shops.length} items van Marktplaats`);
return shops;
}

// â”€â”€â”€ Geocoder: adres â†’ lat/lng via Nominatim (OpenStreetMap, gratis) â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function geocodeShop(shop) {
if (shop.lat !== 52.13 || !shop.address) return shop; // al gecodeerd
try {
const query = [shop.address, shop.city, â€˜Nederlandâ€™].filter(Boolean).join(â€™, â€™);
const res = await axios.get(â€˜https://nominatim.openstreetmap.org/searchâ€™, {
params: { q: query, format: â€˜jsonâ€™, limit: 1, countrycodes: â€˜nlâ€™ },
headers: { â€˜User-Agentâ€™: â€˜KringloopKompas/1.0 (persoonlijk gebruik)â€™ },
timeout: 5000,
});
if (res.data?.[0]) {
shop.lat = parseFloat(res.data[0].lat);
shop.lng = parseFloat(res.data[0].lon);
}
await new Promise(r => setTimeout(r, 1100)); // Nominatim rate limit: max 1/sec
} catch { /* stil falen */ }
return shop;
}

// â”€â”€â”€ Dedupliceer op id â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function deduplicate(shops) {
const seen = new Map();
for (const shop of shops) {
if (!seen.has(shop.id)) {
seen.set(shop.id, shop);
} else {
// Merge: neem de beste data
const existing = seen.get(shop.id);
if (shop.rating > existing.rating) existing.rating = shop.rating;
if (shop.phone && !existing.phone) existing.phone = shop.phone;
if (shop.website && !existing.website) existing.website = shop.website;
const allCats = [â€¦new Set([â€¦existing.assortment, â€¦shop.assortment])];
existing.assortment = allCats;
}
}
return [â€¦seen.values()];
}

// â”€â”€â”€ Hoofd scrape-functie â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function runScraper({ sources = [â€˜osmâ€™, â€˜kringloopwijzerâ€™] } = {}) {
console.log(â€™\nðŸš€ KringloopKompas scraper gestart:â€™, new Date().toLocaleString(â€˜nl-NLâ€™));
let allShops = [];

if (sources.includes(â€˜osmâ€™)) {
try {
const shops = await scrapeOpenStreetMap();
allShops.push(â€¦shops);
logScrape(â€˜openstreetmapâ€™, â€˜successâ€™, shops.length, null);
} catch (e) {
console.error(â€˜OSM fout:â€™, e.message);
logScrape(â€˜openstreetmapâ€™, â€˜errorâ€™, 0, e.message);
}
}

if (sources.includes(â€˜kringloopwijzerâ€™)) {
try {
const shops = await scrapeKringloopwijzer();
allShops.push(â€¦shops);
logScrape(â€˜kringloopwijzerâ€™, â€˜successâ€™, shops.length, null);
} catch (e) {
console.error(â€˜Kringloopwijzer fout:â€™, e.message);
logScrape(â€˜kringloopwijzerâ€™, â€˜errorâ€™, 0, e.message);
}
}

if (sources.includes(â€˜marktplaatsâ€™)) {
try {
const shops = await scrapeMarktplaatsVintage();
allShops.push(â€¦shops);
logScrape(â€˜marktplaatsâ€™, â€˜successâ€™, shops.length, null);
} catch (e) {
console.error(â€˜Marktplaats fout:â€™, e.message);
logScrape(â€˜marktplaatsâ€™, â€˜errorâ€™, 0, e.message);
}
}

// Dedupliceer
const unique = deduplicate(allShops);
console.log(`\nâœ‚ï¸  Na deduplicatie: ${unique.length} unieke winkels (was ${allShops.length})`);

// Filter: alleen winkels met relevante categorieÃ«n
const relevant = unique.filter(s =>
s.assortment.some(a => [â€˜Kledingâ€™,â€˜Vintageâ€™,â€˜Stoffenâ€™,â€˜Naaibenodigdhedenâ€™,â€˜Accessoiresâ€™,â€˜Sieradenâ€™].includes(a))
);
console.log(`ðŸ§µ Relevant voor kleding/stoffen: ${relevant.length} winkels`);

// Geocode shops zonder coÃ¶rdinaten (max 50 per run om de Nominatim limiet te respecteren)
const toGeocode = relevant.filter(s => s.lat === 52.13).slice(0, 50);
if (toGeocode.length > 0) {
console.log(`ðŸ“ Geocoding ${toGeocode.length} adressen...`);
for (const shop of toGeocode) await geocodeShop(shop);
}

// Sla op in database
let saved = 0;
for (const shop of relevant) {
try {
upsert(shop);
saved++;
} catch (e) {
console.warn(`  âš  Kon ${shop.name} niet opslaan:`, e.message);
}
}

console.log(`\nâœ… Klaar! ${saved} winkels opgeslagen in database.\n`);
return { total: allShops.length, unique: unique.length, relevant: relevant.length, saved };
}

// Draai direct als script
if (require.main === module) {
runScraper({ sources: [â€˜osmâ€™, â€˜kringloopwijzerâ€™] })
.then(r => { console.log(â€˜Resultaat:â€™, r); process.exit(0); })
.catch(e => { console.error(e); process.exit(1); });
}

module.exports = { runScraper };
